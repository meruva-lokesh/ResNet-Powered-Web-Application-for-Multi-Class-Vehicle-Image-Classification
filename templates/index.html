import streamlit as st
import tensorflow as tf
import numpy as np
from PIL import Image
import joblib
import os

# Load model and labels
@st.cache_resource
def load_model():
    model = tf.keras.models.load_model('vehicle_classifier.h5')
    class_labels = joblib.load('class_labels.pkl')
    return model, class_labels

def preprocess_image(img):
    img = img.resize((224, 224))
    img_array = np.array(img)
    img_array = np.expand_dims(img_array, axis=0) / 255.0
    return img_array

def main():
    st.set_page_config(page_title="Vehicle Classifier", page_icon="ðŸš—")

    # Custom CSS
    st.markdown("""
        <style>
        .main {
            background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            padding: 2rem;
        }
        .stButton>button {
            background-color: #4CAF50;
            color: white;
            border-radius: 50px;
            padding: 0.5rem 2rem;
        }
        </style>
    """, unsafe_allow_html=True)

    st.title("ðŸš— Vehicle Classification System")

    try:
        # Load model
        model, class_labels = load_model()

        # File upload
        uploaded_file = st.file_uploader("Choose a vehicle image...", type=["jpg", "jpeg", "png"])

        if uploaded_file is not None:
            # Display image
            image = Image.open(uploaded_file)
            st.image(image, caption='Uploaded Image', use_column_width=True)

            # Add predict button
            if st.button('Predict'):
                with st.spinner('Analyzing image...'):
                    # Preprocess and predict
                    processed_img = preprocess_image(image)
                    prediction = model.predict(processed_img)
                    predicted_class = np.argmax(prediction)
                    class_name = list(class_labels.keys())[predicted_class]
                    confidence = float(prediction[0][predicted_class])

                    # Display results
                    st.success(f"Predicted Class: {class_name}")
                    st.progress(confidence)
                    st.info(f"Confidence: {confidence*100:.2f}%")

    except Exception as e:
        st.error(f"An error occurred: {str(e)}")

if __name__ == '__main__':
    main()